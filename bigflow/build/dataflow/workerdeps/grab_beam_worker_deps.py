#!/usr/bin/evn python

# Crawl Dataflow documentation, generates requirements files for various beam/python combinations.
# Requirements: `requests`, `beautifulsoup4`

import requests
import bs4
import re
import os


BEAM_VERSIONS = {
    "2.24", "2.25", "2.26", "2.27",
}


def grab_sdk_worker_dependencies():

    page = requests.get("https://cloud.google.com/dataflow/docs/concepts/sdk-worker-dependencies")
    page.raise_for_status()

    bs = bs4.BeautifulSoup(page.text, features='html.parser')

    for s in bs.find_all('section'):
        if not re.match(r"py\d+", s.get('id', "")):
            continue

        beam_ver = s.h4['id'].split("-")[-1]
        beam_ver = ".".join(beam_ver.split(".")[:2])  # only major_minor

        for ss in s.find_all('section'):
            python_ver = ss.h3['id'].split("-")[-1]
            python_ver = ".".join(python_ver.split(".")[:2])  # only major_minor

            packages = {}
            for tr in ss.find_all('tr'):
                if not tr.td and tr.th:
                    # header
                    continue
                pkg = tr.td.text
                ver = tr.td.next_sibling.text
                packages[pkg] = ver

            yield {
                'python_version': python_ver,
                'beam_version': beam_ver,
                'packages': packages,
            }


def main():

    wdeps = list(grab_sdk_worker_dependencies())
    print("python versions", sorted(set(p['python_version'] for p in wdeps)))
    print("beam versions", sorted(set(p['beam_version'] for p in wdeps)))

    for p in wdeps:
        beam_version = p['beam_version']
        if beam_version not in BEAM_VERSIONS:
            print("skip beam version", beam_version)
            continue

        python_version = p['python_version']
        pkgs = p['packages']

        fn = f"beam{beam_version}_py{python_version}.txt"
        wd = os.path.join(os.path.dirname(__file__))

        with open(os.path.join(wd, fn), 'w') as f:
            print(f.name)

            f.write(f"# list of preinstalled dependencies on Dataflow workers\n")
            f.write(f"# this file was generated by `grab_beam_worker_deps.py`\n")
            f.write(f"# beam sdk version: {beam_version}\n")
            f.write(f"# python version: {python_version}\n")
            f.write("\n")

            for p, v in sorted(pkgs.items()):
                f.write(f"{p}=={v}\n")


if __name__ == '__main__':
    main()